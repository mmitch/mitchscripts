#!/bin/bash
#
# wait until dropbox is idle
#
# optionally needs dzen2 and zenity

LANG=en_US.utf8
LANGUAGE=en_US.utf8
LC_MESSAGES=en_US.utf8
export LANG
export LANGUAGE
export LC_MESSAGES

# dropbox daemon sometimes changes this :/
IDLESTATUS="Up to date"

# is there a dropbox?
if [ "$(dropbox status)" = "Dropbox isn't running!" ] ; then
    # warn
    echo "Dropbox isn't running!" >&2
    zenity --warning --text="Dropbox isn't running!" 2>/dev/null ||  true
    # we're finished, nothing to do :)
    exit 1
fi

TIMER=2

# wait until idle
if [ "$(dropbox status)" != "$IDLESTATUS" ]; then

    if [ -x "$(which dzen2)" ] && [ "$DISPLAY" ]; then

        # graphical

	(
	    echo '^tw()Waiting for dropbox to settle...'
	    while [ "$(dropbox status)" != "$IDLESTATUS" ]; do
		dropbox status
		sleep $TIMER
#		echo
	    done
	) | dzen2 -bg darkred -fg grey80 -fn fixed -l 2 -e 'button1=exec:killall wait-for-dropbox;onstart=uncollapse;enterslave=collapse;entertitle=uncollapse' -ta left

    else

        # text only

	echo -n 'Waiting for dropbox to settle...'
	while [ "$(dropbox status)" != "$IDLESTATUS" ]; do
	    sleep $TIMER
	    echo -n .
	done
	echo
	echo

    fi

fi
